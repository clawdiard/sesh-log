<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SeshLog â€” Skateboarding Session Logger</title>
  <meta name="description" content="Log your skateboarding sessions, track tricks landed, and watch your progression over time. No account needed â€” all data stays on your device.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›¹</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --card: #14141f;
      --border: #1e1e2e;
      --accent: #6c5ce7;
      --accent2: #a29bfe;
      --text: #e0e0e8;
      --muted: #7a7a8e;
      --green: #00cec9;
      --red: #ff7675;
      --orange: #fdcb6e;
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .container { max-width: 640px; margin: 0 auto; padding: 16px; }
    
    header { text-align: center; padding: 32px 0 24px; }
    header h1 { font-size: 2rem; font-weight: 800; }
    header h1 span { color: var(--accent); }
    header p { color: var(--muted); margin-top: 4px; font-size: 0.9rem; }
    
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--card); border-radius: var(--radius); padding: 4px; }
    .tab { flex: 1; padding: 10px; text-align: center; border: none; background: transparent; color: var(--muted); font-size: 0.85rem; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
    .tab.active { background: var(--accent); color: #fff; }
    
    .panel { display: none; }
    .panel.active { display: block; }
    
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
    
    label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    input, textarea, select { width: 100%; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95rem; outline: none; font-family: inherit; }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 60px; }
    
    .row { display: flex; gap: 12px; }
    .row > * { flex: 1; }
    .field { margin-bottom: 12px; }
    
    .trick-picker { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; max-height: 200px; overflow-y: auto; padding: 8px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border); }
    .trick-chip { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; border: 1px solid var(--border); background: var(--card); color: var(--muted); cursor: pointer; transition: all 0.15s; user-select: none; }
    .trick-chip.selected { background: var(--accent); color: #fff; border-color: var(--accent); }
    .trick-chip:hover { border-color: var(--accent2); }
    
    .mood-picker { display: flex; gap: 8px; margin-top: 6px; }
    .mood-btn { font-size: 1.5rem; background: var(--bg); border: 2px solid var(--border); border-radius: 10px; padding: 8px 12px; cursor: pointer; transition: all 0.15s; }
    .mood-btn.selected { border-color: var(--accent); background: var(--card); transform: scale(1.1); }
    
    .btn { width: 100%; padding: 12px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn-danger { background: var(--red); }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; margin: 0; }
    
    .session-item { cursor: pointer; transition: all 0.15s; }
    .session-item:hover { border-color: var(--accent2); }
    .session-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .session-date { font-weight: 700; }
    .session-mood { font-size: 1.2rem; }
    .session-location { color: var(--muted); font-size: 0.85rem; }
    .session-tricks { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
    .session-tricks .trick-chip { font-size: 0.75rem; cursor: default; }
    .session-duration { color: var(--green); font-size: 0.85rem; font-weight: 600; }
    .session-notes { color: var(--muted); font-size: 0.85rem; margin-top: 6px; font-style: italic; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
    .chart-section { margin-top: 16px; }
    .chart-section .card { padding: 16px; }
    .chart-section h3 { margin-bottom: 12px; }
    .chart-toggle { display: flex; gap: 4px; margin-bottom: 12px; background: var(--bg); border-radius: 8px; padding: 3px; }
    .chart-toggle button { flex: 1; padding: 6px 10px; border: none; background: transparent; color: var(--muted); font-size: 0.78rem; font-weight: 600; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .chart-toggle button.active { background: var(--accent); color: #fff; }
    canvas.chart-canvas { width: 100% !important; max-height: 220px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; text-align: center; }
    .stat-num { font-size: 1.8rem; font-weight: 800; color: var(--accent); }
    .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
    
    .streak-bar { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; text-align: center; }
    .streak-bar .fire { font-size: 2rem; }
    .streak-bar .streak-num { font-size: 1.4rem; font-weight: 800; color: var(--orange); }
    
    .top-tricks { margin-top: 12px; }
    .top-trick-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .top-trick-row:last-child { border: none; }
    .top-trick-name { font-weight: 600; }
    .top-trick-count { color: var(--accent); font-weight: 700; }
    
    .empty-state { text-align: center; padding: 40px 16px; color: var(--muted); }
    .empty-state .emoji { font-size: 3rem; margin-bottom: 12px; }
    .empty-state p { font-size: 0.95rem; }
    
    .filter-row { margin-bottom: 12px; }
    .filter-row input { font-size: 0.85rem; padding: 8px 12px; }
    
    .detail-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
    .detail-overlay.open { display: flex; }
    .detail-sheet { background: var(--card); border-radius: var(--radius) var(--radius) 0 0; width: 100%; max-width: 640px; max-height: 80vh; overflow-y: auto; padding: 24px 16px; }
    .detail-sheet h3 { margin-bottom: 12px; }
    .detail-actions { display: flex; gap: 8px; margin-top: 16px; }
    
    .category-header { font-size: 0.75rem; color: var(--accent2); text-transform: uppercase; letter-spacing: 0.5px; width: 100%; margin-top: 8px; font-weight: 700; }
    
    .goal-card { position: relative; overflow: hidden; }
    .goal-progress-bg { position: absolute; top: 0; left: 0; height: 100%; background: rgba(108,92,231,0.1); transition: width 0.5s ease; z-index: 0; }
    .goal-card > *:not(.goal-progress-bg) { position: relative; z-index: 1; }
    .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .goal-title { font-weight: 700; font-size: 0.95rem; }
    .goal-deadline { font-size: 0.78rem; color: var(--muted); }
    .goal-deadline.overdue { color: var(--red); }
    .goal-bar { height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; margin: 8px 0; }
    .goal-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--accent), var(--accent2)); transition: width 0.5s ease; }
    .goal-bar-fill.complete { background: linear-gradient(90deg, var(--green), #55efc4); }
    .goal-nums { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--muted); }
    .goal-complete-banner { text-align: center; font-size: 1.1rem; font-weight: 700; color: var(--green); margin-top: 6px; }
    .goal-actions { display: flex; gap: 6px; margin-top: 10px; }
    
    .badge-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .badge-card { text-align: center; padding: 20px 12px; transition: all 0.2s; }
    .badge-card.locked { opacity: 0.35; filter: grayscale(1); }
    .badge-icon { font-size: 2.5rem; margin-bottom: 6px; font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Twemoji Mozilla', sans-serif; line-height: 1; }
    .badge-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 2px; }
    .badge-desc { font-size: 0.75rem; color: var(--muted); }
    .badge-date { font-size: 0.7rem; color: var(--green); margin-top: 4px; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ›¹ Sesh<span>Log</span></h1>
      <p>Track your sessions. Watch your progression.</p>
    </header>
    
    <div class="tabs">
      <button class="tab active" data-tab="log">+ Log</button>
      <button class="tab" data-tab="history">History</button>
      <button class="tab" data-tab="stats">Stats</button>
      <button class="tab" data-tab="goals">Goals</button>
      <button class="tab" data-tab="data">Data</button>
    </div>
    
    <!-- LOG PANEL -->
    <div class="panel active" id="panel-log">
      <div class="card">
        <div class="row">
          <div class="field">
            <label>Date</label>
            <input type="date" id="sesh-date">
          </div>
          <div class="field">
            <label>Duration (min)</label>
            <input type="number" id="sesh-duration" placeholder="60" min="1">
          </div>
        </div>
        <div class="field">
          <label>Location</label>
          <input type="text" id="sesh-location" placeholder="LES Skatepark, local spot, etc.">
        </div>
        <div class="field">
          <label>Mood</label>
          <div class="mood-picker">
            <button class="mood-btn" data-mood="ğŸ”¥">ğŸ”¥</button>
            <button class="mood-btn" data-mood="ğŸ˜Š">ğŸ˜Š</button>
            <button class="mood-btn" data-mood="ğŸ˜">ğŸ˜</button>
            <button class="mood-btn" data-mood="ğŸ˜¤">ğŸ˜¤</button>
            <button class="mood-btn" data-mood="ğŸ¤•">ğŸ¤•</button>
          </div>
        </div>
        <div class="field">
          <label>Tricks Landed</label>
          <input type="text" id="trick-search" placeholder="Search tricks...">
          <div class="trick-picker" id="trick-picker"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input type="text" id="custom-trick-input" placeholder="Add a custom trick..." style="flex:1">
            <button class="btn btn-sm" id="add-custom-trick-btn" style="white-space:nowrap">+ Add</button>
          </div>
        </div>
        <div class="field">
          <label>ğŸ“¸ Session Photo</label>
          <div id="photo-area" style="margin-top:6px">
            <input type="file" id="sesh-photo" accept="image/*" capture="environment" style="display:none">
            <div id="photo-preview" style="display:none;position:relative;margin-bottom:8px">
              <img id="photo-preview-img" style="width:100%;border-radius:8px;border:1px solid var(--border)">
              <button id="photo-remove" style="position:absolute;top:6px;right:6px;background:var(--red);color:#fff;border:none;border-radius:50%;width:28px;height:28px;font-size:1rem;cursor:pointer;line-height:1">Ã—</button>
            </div>
            <button class="btn btn-sm" id="photo-add-btn" style="background:var(--card);border:1px solid var(--border);color:var(--muted)">ğŸ“· Add Photo</button>
          </div>
        </div>
        <div class="field">
          <label>Notes</label>
          <textarea id="sesh-notes" placeholder="How did it go? What did you work on?"></textarea>
        </div>
        <button class="btn" id="save-btn">Save Session</button>
      </div>
    </div>
    
    <!-- HISTORY PANEL -->
    <div class="panel" id="panel-history">
      <div class="filter-row">
        <input type="text" id="history-search" placeholder="Search sessions...">
      </div>
      <div id="history-list"></div>
    </div>
    
    <!-- STATS PANEL -->
    <div class="panel" id="panel-stats">
      <div id="stats-content"></div>
    </div>

    <!-- GOALS PANEL -->
    <div class="panel" id="panel-goals">
      <div class="tabs" style="margin-bottom:16px" id="goals-subtabs">
        <button class="tab active" data-subtab="active-goals">Active Goals</button>
        <button class="tab" data-subtab="achievements">ğŸ… Badges</button>
      </div>
      <div id="subtab-active-goals">
        <div class="card" id="goal-form-card">
          <h3 style="margin-bottom:12px">ğŸ¯ New Goal</h3>
          <div class="field">
            <label>Goal Type</label>
            <select id="goal-type">
              <option value="trick-count">Land a trick X times</option>
              <option value="unique-tricks">Learn X new tricks</option>
              <option value="session-count">Log X sessions</option>
              <option value="total-minutes">Skate X total minutes</option>
              <option value="streak">Maintain X-day streak</option>
            </select>
          </div>
          <div class="field" id="goal-trick-field">
            <label>Trick</label>
            <select id="goal-trick"></select>
          </div>
          <div class="row">
            <div class="field">
              <label>Target</label>
              <input type="number" id="goal-target" placeholder="10" min="1">
            </div>
            <div class="field">
              <label>Deadline</label>
              <input type="date" id="goal-deadline">
            </div>
          </div>
          <button class="btn" id="save-goal-btn">Set Goal</button>
        </div>
        <div id="goals-list" style="margin-top:16px"></div>
      </div>
      <div id="subtab-achievements" style="display:none">
        <div id="achievements-grid"></div>
      </div>
    </div>

    <!-- DATA PANEL -->
    <div class="panel" id="panel-data">
      <div class="card">
        <h3 style="margin-bottom:12px">ğŸ“¦ Export</h3>
        <p style="color:var(--muted);font-size:0.85rem;margin-bottom:12px">Download all your sessions as a JSON file. Use this to back up your data or transfer it to another device.</p>
        <button class="btn" id="export-btn">â¬‡ Export Sessions (JSON)</button>
      </div>
      <div class="card" style="margin-top:12px">
        <h3 style="margin-bottom:12px">ğŸ“¥ Import</h3>
        <p style="color:var(--muted);font-size:0.85rem;margin-bottom:12px">Import sessions from a JSON backup file. You can choose to merge with existing data or replace it entirely.</p>
        <input type="file" id="import-file" accept=".json,application/json" style="margin-bottom:12px">
        <div class="row">
          <button class="btn" id="import-merge-btn" style="background:var(--green)">Merge with Existing</button>
          <button class="btn btn-danger" id="import-replace-btn">Replace All</button>
        </div>
        <div id="import-status" style="margin-top:12px;font-size:0.85rem;color:var(--muted);display:none"></div>
      </div>
    </div>
  </div>
  
  <!-- DETAIL OVERLAY -->
  <div class="detail-overlay" id="detail-overlay">
    <div class="detail-sheet" id="detail-sheet"></div>
  </div>

  <script>
    // --- DATA ---
    let TRICKS = [];
    let sessions = JSON.parse(localStorage.getItem('seshlog_sessions') || '[]');
    let selectedTricks = new Set();
    let selectedMood = '';

    let customTricks = JSON.parse(localStorage.getItem('seshlog_custom_tricks') || '[]');
    fetch('data/tricks.json').then(r => r.json()).then(t => { TRICKS = t.concat(customTricks); renderTrickPicker(); });

    // --- CUSTOM TRICK ---
    document.getElementById('add-custom-trick-btn').addEventListener('click', addCustomTrick);
    document.getElementById('custom-trick-input').addEventListener('keydown', e => { if (e.key === 'Enter') addCustomTrick(); });
    function addCustomTrick() {
      const input = document.getElementById('custom-trick-input');
      const name = input.value.trim();
      if (!name) return;
      const id = 'custom-' + name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
      if (TRICKS.find(t => t.id === id)) { input.value = ''; selectedTricks.add(id); renderTrickPicker(); return; }
      const trick = { id, name, category: 'Custom', difficulty: 3 };
      customTricks.push(trick);
      TRICKS.push(trick);
      localStorage.setItem('seshlog_custom_tricks', JSON.stringify(customTricks));
      selectedTricks.add(id);
      input.value = '';
      renderTrickPicker();
    }

    // --- PHOTO ---
    let sessionPhoto = null;
    const photoInput = document.getElementById('sesh-photo');
    const photoPreview = document.getElementById('photo-preview');
    const photoPreviewImg = document.getElementById('photo-preview-img');
    document.getElementById('photo-add-btn').addEventListener('click', () => photoInput.click());
    document.getElementById('photo-remove').addEventListener('click', () => { sessionPhoto = null; photoPreview.style.display = 'none'; document.getElementById('photo-add-btn').style.display = ''; });
    photoInput.addEventListener('change', () => {
      const file = photoInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        // Resize to max 800px to save localStorage space
        const img = new Image();
        img.onload = () => {
          const MAX = 800;
          let w = img.width, h = img.height;
          if (w > MAX || h > MAX) { const r = Math.min(MAX/w, MAX/h); w = Math.round(w*r); h = Math.round(h*r); }
          const c = document.createElement('canvas'); c.width = w; c.height = h;
          c.getContext('2d').drawImage(img, 0, 0, w, h);
          sessionPhoto = c.toDataURL('image/jpeg', 0.7);
          photoPreviewImg.src = sessionPhoto;
          photoPreview.style.display = 'block';
          document.getElementById('photo-add-btn').style.display = 'none';
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    // --- TABS ---
    document.querySelectorAll('.tab[data-tab]').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab[data-tab]').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
        if (tab.dataset.tab === 'history') renderHistory();
        if (tab.dataset.tab === 'stats') renderStats();
        if (tab.dataset.tab === 'goals') { renderGoals(); populateGoalTricks(); }
      });
    });

    // --- MOOD ---
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMood = btn.dataset.mood;
      });
    });

    // --- TRICKS ---
    function renderTrickPicker(filter = '') {
      const picker = document.getElementById('trick-picker');
      const f = filter.toLowerCase();
      const grouped = {};
      TRICKS.filter(t => !f || t.name.toLowerCase().includes(f) || t.category.toLowerCase().includes(f))
        .forEach(t => { (grouped[t.category] = grouped[t.category] || []).push(t); });
      picker.innerHTML = '';
      Object.keys(grouped).sort().forEach(cat => {
        const h = document.createElement('div');
        h.className = 'category-header';
        h.textContent = cat;
        picker.appendChild(h);
        grouped[cat].sort((a,b) => a.difficulty - b.difficulty).forEach(t => {
          const chip = document.createElement('span');
          chip.className = 'trick-chip' + (selectedTricks.has(t.id) ? ' selected' : '');
          chip.textContent = t.name;
          chip.onclick = () => { selectedTricks.has(t.id) ? selectedTricks.delete(t.id) : selectedTricks.add(t.id); renderTrickPicker(filter); };
          picker.appendChild(chip);
        });
      });
    }
    document.getElementById('trick-search').addEventListener('input', e => renderTrickPicker(e.target.value));

    // --- SAVE ---
    document.getElementById('sesh-date').valueAsDate = new Date();
    document.getElementById('save-btn').addEventListener('click', () => {
      const date = document.getElementById('sesh-date').value;
      const duration = parseInt(document.getElementById('sesh-duration').value) || 0;
      const location = document.getElementById('sesh-location').value.trim();
      const notes = document.getElementById('sesh-notes').value.trim();
      if (!date) return alert('Pick a date!');
      const sesh = {
        id: Date.now().toString(36),
        date, duration, location, notes,
        mood: selectedMood,
        tricks: Array.from(selectedTricks),
        photo: sessionPhoto || null,
        createdAt: new Date().toISOString()
      };
      sessions.unshift(sesh);
      localStorage.setItem('seshlog_sessions', JSON.stringify(sessions));
      // Reset
      document.getElementById('sesh-duration').value = '';
      document.getElementById('sesh-location').value = '';
      document.getElementById('sesh-notes').value = '';
      selectedTricks.clear();
      selectedMood = '';
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
      sessionPhoto = null; photoPreview.style.display = 'none'; document.getElementById('photo-add-btn').style.display = '';
      document.getElementById('trick-search').value = '';
      renderTrickPicker();
      alert('Session saved! ğŸ¤™');
    });

    // --- HISTORY ---
    function renderHistory(filter = '') {
      const list = document.getElementById('history-list');
      const f = filter.toLowerCase();
      const filtered = sessions.filter(s => !f || s.location.toLowerCase().includes(f) || s.notes.toLowerCase().includes(f) || s.tricks.some(t => t.includes(f)));
      if (!filtered.length) {
        list.innerHTML = '<div class="empty-state"><div class="emoji">ğŸ“‹</div><p>No sessions yet. Go skate and log it!</p></div>';
        return;
      }
      list.innerHTML = filtered.map(s => {
        const trickNames = s.tricks.map(id => { const t = TRICKS.find(x => x.id === id); return t ? t.name : id; });
        return `<div class="card session-item" onclick="showDetail('${s.id}')">
          <div class="session-meta">
            <span class="session-date">${new Date(s.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</span>
            <span class="session-mood">${s.mood || ''}</span>
          </div>
          ${s.location ? `<div class="session-location">ğŸ“ ${s.location}</div>` : ''}
          ${s.photo ? `<img src="${s.photo}" style="width:100%;border-radius:8px;margin-top:8px;border:1px solid var(--border)">` : ''}
          ${s.duration ? `<div class="session-duration">â± ${s.duration} min</div>` : ''}
          ${trickNames.length ? `<div class="session-tricks">${trickNames.map(n => `<span class="trick-chip selected">${n}</span>`).join('')}</div>` : ''}
          ${s.notes ? `<div class="session-notes">${s.notes}</div>` : ''}
        </div>`;
      }).join('');
    }
    document.getElementById('history-search').addEventListener('input', e => renderHistory(e.target.value));

    // --- DETAIL ---
    window.showDetail = function(id) {
      const s = sessions.find(x => x.id === id);
      if (!s) return;
      const trickNames = s.tricks.map(tid => { const t = TRICKS.find(x => x.id === tid); return t ? t.name : tid; });
      const sheet = document.getElementById('detail-sheet');
      sheet.innerHTML = `
        <h3>${s.mood || 'ğŸ›¹'} ${new Date(s.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</h3>
        ${s.location ? `<p>ğŸ“ <strong>${s.location}</strong></p>` : ''}
        ${s.photo ? `<img src="${s.photo}" style="width:100%;border-radius:8px;margin:8px 0;border:1px solid var(--border)">` : ''}
        ${s.duration ? `<p>â± ${s.duration} minutes</p>` : ''}
        ${trickNames.length ? `<p style="margin-top:8px"><strong>Tricks Landed:</strong></p><div class="session-tricks" style="margin-top:4px">${trickNames.map(n => `<span class="trick-chip selected">${n}</span>`).join('')}</div>` : ''}
        ${s.notes ? `<p style="margin-top:12px"><strong>Notes:</strong></p><p style="color:var(--muted);font-style:italic">${s.notes}</p>` : ''}
        <div class="detail-actions">
          <button class="btn btn-sm" onclick="closeDetail()">Close</button>
          <button class="btn btn-sm btn-danger" onclick="deleteSession('${s.id}')">Delete</button>
        </div>`;
      document.getElementById('detail-overlay').classList.add('open');
    };
    window.closeDetail = () => document.getElementById('detail-overlay').classList.remove('open');
    window.deleteSession = function(id) {
      if (!confirm('Delete this session?')) return;
      sessions = sessions.filter(s => s.id !== id);
      localStorage.setItem('seshlog_sessions', JSON.stringify(sessions));
      closeDetail();
      renderHistory();
    };
    document.getElementById('detail-overlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeDetail(); });

    // --- STATS ---
    function renderStats() {
      const el = document.getElementById('stats-content');
      if (!sessions.length) {
        el.innerHTML = '<div class="empty-state"><div class="emoji">ğŸ“Š</div><p>Log some sessions to see your stats!</p></div>';
        return;
      }
      const totalSessions = sessions.length;
      const totalMinutes = sessions.reduce((a, s) => a + (s.duration || 0), 0);
      const totalHours = (totalMinutes / 60).toFixed(1);
      const allTricks = sessions.flatMap(s => s.tricks);
      const uniqueTricks = new Set(allTricks).size;
      
      // Streak
      const dates = [...new Set(sessions.map(s => s.date))].sort().reverse();
      let streak = 0;
      const today = new Date().toISOString().slice(0, 10);
      let check = new Date(today);
      for (let i = 0; i < 365; i++) {
        const d = check.toISOString().slice(0, 10);
        if (dates.includes(d)) { streak++; check.setDate(check.getDate() - 1); }
        else if (i === 0) { check.setDate(check.getDate() - 1); } // allow today not logged yet
        else break;
      }

      // Top tricks
      const trickCounts = {};
      allTricks.forEach(t => trickCounts[t] = (trickCounts[t] || 0) + 1);
      const top5 = Object.entries(trickCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

      el.innerHTML = `
        <div class="streak-bar">
          <div class="fire">ğŸ”¥</div>
          <div class="streak-num">${streak}-day streak</div>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-num">${totalSessions}</div><div class="stat-label">Sessions</div></div>
          <div class="stat-card"><div class="stat-num">${totalHours}h</div><div class="stat-label">Time on Board</div></div>
          <div class="stat-card"><div class="stat-num">${uniqueTricks}</div><div class="stat-label">Unique Tricks</div></div>
          <div class="stat-card"><div class="stat-num">${allTricks.length}</div><div class="stat-label">Total Trick Lands</div></div>
        </div>
        ${top5.length ? `<div class="card"><h3 style="margin-bottom:8px">ğŸ† Most Landed</h3><div class="top-tricks">${top5.map(([id, count]) => {
          const t = TRICKS.find(x => x.id === id);
          return `<div class="top-trick-row"><span class="top-trick-name">${t ? t.name : id}</span><span class="top-trick-count">Ã—${count}</span></div>`;
        }).join('')}</div></div>` : ''}
      `;

      // --- PROGRESS CHARTS ---
      const chartSection = document.createElement('div');
      chartSection.className = 'chart-section';
      chartSection.innerHTML = `
        <div class="card">
          <h3>ğŸ“ˆ Sessions Over Time</h3>
          <div class="chart-toggle" id="sessions-chart-toggle">
            <button class="active" data-range="weekly">Weekly</button>
            <button data-range="monthly">Monthly</button>
          </div>
          <canvas id="sessions-chart" class="chart-canvas"></canvas>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>ğŸ›¹ Tricks Progression</h3>
          <div class="chart-toggle" id="tricks-chart-toggle">
            <button class="active" data-range="weekly">Weekly</button>
            <button data-range="monthly">Monthly</button>
          </div>
          <canvas id="tricks-chart" class="chart-canvas"></canvas>
        </div>
      `;
      el.appendChild(chartSection);

      buildSessionsChart('weekly');
      buildTricksChart('weekly');

      document.getElementById('sessions-chart-toggle').addEventListener('click', e => {
        if (!e.target.dataset.range) return;
        e.currentTarget.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        buildSessionsChart(e.target.dataset.range);
      });
      document.getElementById('tricks-chart-toggle').addEventListener('click', e => {
        if (!e.target.dataset.range) return;
        e.currentTarget.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        buildTricksChart(e.target.dataset.range);
      });
    }

    let sessionsChartInst = null;
    let tricksChartInst = null;

    function bucketSessions(range) {
      const buckets = {};
      sessions.forEach(s => {
        let key;
        if (range === 'weekly') {
          const d = new Date(s.date);
          const day = d.getDay();
          const diff = d.getDate() - day + (day === 0 ? -6 : 1);
          const monday = new Date(d.setDate(diff));
          key = monday.toISOString().slice(0, 10);
        } else {
          key = s.date.slice(0, 7);
        }
        if (!buckets[key]) buckets[key] = [];
        buckets[key].push(s);
      });
      const sorted = Object.keys(buckets).sort();
      const last = sorted.slice(-12);
      return last.map(k => ({
        label: range === 'weekly' ? 'W/' + k.slice(5) : k.slice(0, 7),
        sessions: buckets[k]
      }));
    }

    function chartColors() {
      return {
        bg: 'rgba(108,92,231,0.35)',
        border: '#6c5ce7',
        bg2: 'rgba(0,206,201,0.35)',
        border2: '#00cec9',
        grid: 'rgba(255,255,255,0.06)',
        tick: '#7a7a8e'
      };
    }

    function buildSessionsChart(range) {
      const data = bucketSessions(range);
      const ctx = document.getElementById('sessions-chart');
      if (sessionsChartInst) sessionsChartInst.destroy();
      const c = chartColors();
      sessionsChartInst = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.label),
          datasets: [{
            label: 'Sessions',
            data: data.map(d => d.sessions.length),
            backgroundColor: c.bg,
            borderColor: c.border,
            borderWidth: 2,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: c.grid }, ticks: { color: c.tick, font: { size: 10 } } },
            y: { beginAtZero: true, grid: { color: c.grid }, ticks: { color: c.tick, stepSize: 1 } }
          }
        }
      });
    }

    function buildTricksChart(range) {
      const data = bucketSessions(range);
      const ctx = document.getElementById('tricks-chart');
      if (tricksChartInst) tricksChartInst.destroy();
      const c = chartColors();
      // cumulative unique tricks over time
      const seenTricks = new Set();
      const uniqueCounts = [];
      const totalCounts = [];
      data.forEach(d => {
        d.sessions.forEach(s => s.tricks.forEach(t => seenTricks.add(t)));
        uniqueCounts.push(seenTricks.size);
        totalCounts.push(d.sessions.reduce((a, s) => a + s.tricks.length, 0));
      });
      tricksChartInst = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.label),
          datasets: [
            {
              label: 'Unique Tricks (cumulative)',
              data: uniqueCounts,
              borderColor: c.border,
              backgroundColor: c.bg,
              fill: true,
              tension: 0.3,
              pointRadius: 4
            },
            {
              label: 'Tricks Landed',
              data: totalCounts,
              borderColor: c.border2,
              backgroundColor: 'transparent',
              borderDash: [5, 3],
              tension: 0.3,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: c.tick, font: { size: 11 } } } },
          scales: {
            x: { grid: { color: c.grid }, ticks: { color: c.tick, font: { size: 10 } } },
            y: { beginAtZero: true, grid: { color: c.grid }, ticks: { color: c.tick } }
          }
        }
      });
    }

    // --- GOALS & ACHIEVEMENTS ---
    let goals = JSON.parse(localStorage.getItem('seshlog_goals') || '[]');
    let unlockedBadges = JSON.parse(localStorage.getItem('seshlog_badges') || '{}');

    // Subtab switching
    document.getElementById('goals-subtabs').addEventListener('click', e => {
      if (!e.target.dataset.subtab) return;
      document.querySelectorAll('#goals-subtabs .tab').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      document.getElementById('subtab-active-goals').style.display = e.target.dataset.subtab === 'active-goals' ? '' : 'none';
      document.getElementById('subtab-achievements').style.display = e.target.dataset.subtab === 'achievements' ? '' : 'none';
      if (e.target.dataset.subtab === 'achievements') renderAchievements();
    });

    // Goal type toggle trick field visibility
    const goalTypeEl = document.getElementById('goal-type');
    const goalTrickField = document.getElementById('goal-trick-field');
    goalTypeEl.addEventListener('change', () => {
      goalTrickField.style.display = goalTypeEl.value === 'trick-count' ? '' : 'none';
    });

    // Populate trick dropdown when TRICKS load
    function populateGoalTricks() {
      const sel = document.getElementById('goal-trick');
      sel.innerHTML = TRICKS.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }
    const origFetch = window.fetch;
    // Repopulate after tricks load
    setTimeout(() => populateGoalTricks(), 1000);

    // Set default deadline to 1 week from now
    const dl = new Date(); dl.setDate(dl.getDate() + 7);
    document.getElementById('goal-deadline').value = dl.toISOString().slice(0, 10);

    // Save goal
    document.getElementById('save-goal-btn').addEventListener('click', () => {
      const type = goalTypeEl.value;
      const target = parseInt(document.getElementById('goal-target').value);
      const deadline = document.getElementById('goal-deadline').value;
      if (!target || target < 1) return alert('Set a target!');
      if (!deadline) return alert('Pick a deadline!');
      const goal = {
        id: Date.now().toString(36),
        type,
        trickId: type === 'trick-count' ? document.getElementById('goal-trick').value : null,
        target,
        deadline,
        createdAt: new Date().toISOString(),
        completed: false
      };
      goals.push(goal);
      localStorage.setItem('seshlog_goals', JSON.stringify(goals));
      document.getElementById('goal-target').value = '';
      renderGoals();
    });

    function getGoalProgress(goal) {
      const start = new Date(goal.createdAt);
      const end = new Date(goal.deadline + 'T23:59:59');
      const relevant = sessions.filter(s => {
        const d = new Date(s.date + 'T12:00:00');
        return d >= start && d <= end;
      });
      switch (goal.type) {
        case 'trick-count':
          return relevant.reduce((a, s) => a + s.tricks.filter(t => t === goal.trickId).length, 0);
        case 'unique-tricks': {
          const before = new Set(sessions.filter(s => new Date(s.date+'T12:00:00') < start).flatMap(s => s.tricks));
          const after = new Set(relevant.flatMap(s => s.tricks));
          let count = 0;
          after.forEach(t => { if (!before.has(t)) count++; });
          return count;
        }
        case 'session-count':
          return relevant.length;
        case 'total-minutes':
          return relevant.reduce((a, s) => a + (s.duration || 0), 0);
        case 'streak': {
          const dates = [...new Set(sessions.map(s => s.date))].sort().reverse();
          let streak = 0;
          let check = new Date();
          for (let i = 0; i < 365; i++) {
            const d = check.toISOString().slice(0, 10);
            if (dates.includes(d)) { streak++; check.setDate(check.getDate() - 1); }
            else if (i === 0) { check.setDate(check.getDate() - 1); }
            else break;
          }
          return streak;
        }
        default: return 0;
      }
    }

    function goalLabel(goal) {
      const trickName = goal.trickId ? (TRICKS.find(t => t.id === goal.trickId)?.name || goal.trickId) : '';
      switch (goal.type) {
        case 'trick-count': return `Land ${trickName} ${goal.target}Ã—`;
        case 'unique-tricks': return `Learn ${goal.target} new tricks`;
        case 'session-count': return `Log ${goal.target} sessions`;
        case 'total-minutes': return `Skate ${goal.target} minutes`;
        case 'streak': return `${goal.target}-day streak`;
        default: return 'Goal';
      }
    }

    function renderGoals() {
      const list = document.getElementById('goals-list');
      const active = goals.filter(g => !g.completed);
      const completed = goals.filter(g => g.completed);
      if (!goals.length) {
        list.innerHTML = '<div class="empty-state"><div class="emoji">ğŸ¯</div><p>Set your first goal above!</p></div>';
        return;
      }
      let html = '';
      // Check for newly completed goals
      active.forEach(g => {
        const progress = getGoalProgress(g);
        if (progress >= g.target) {
          g.completed = true;
          g.completedAt = new Date().toISOString();
          localStorage.setItem('seshlog_goals', JSON.stringify(goals));
        }
      });

      const stillActive = goals.filter(g => !g.completed);
      const done = goals.filter(g => g.completed);

      stillActive.forEach(g => {
        const progress = getGoalProgress(g);
        const pct = Math.min(100, Math.round((progress / g.target) * 100));
        const today = new Date().toISOString().slice(0, 10);
        const overdue = g.deadline < today;
        html += `<div class="card goal-card">
          <div class="goal-progress-bg" style="width:${pct}%"></div>
          <div class="goal-header">
            <span class="goal-title">${goalLabel(g)}</span>
            <span class="goal-deadline${overdue ? ' overdue' : ''}">ğŸ“… ${new Date(g.deadline+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>
          </div>
          <div class="goal-bar"><div class="goal-bar-fill" style="width:${pct}%"></div></div>
          <div class="goal-nums"><span>${progress} / ${g.target}</span><span>${pct}%</span></div>
          <div class="goal-actions"><button class="btn btn-sm btn-danger" onclick="deleteGoal('${g.id}')">Remove</button></div>
        </div>`;
      });

      if (done.length) {
        html += '<div style="margin-top:20px"><h3 style="color:var(--green);margin-bottom:12px">âœ… Completed</h3>';
        done.slice(0, 10).forEach(g => {
          html += `<div class="card goal-card" style="opacity:0.7">
            <div class="goal-progress-bg" style="width:100%"></div>
            <div class="goal-header">
              <span class="goal-title">${goalLabel(g)}</span>
              <span class="goal-deadline" style="color:var(--green)">âœ… Done</span>
            </div>
            <div class="goal-bar"><div class="goal-bar-fill complete" style="width:100%"></div></div>
            <div class="goal-complete-banner">ğŸ‰ Goal Achieved!</div>
            <div class="goal-actions"><button class="btn btn-sm btn-danger" onclick="deleteGoal('${g.id}')">Remove</button></div>
          </div>`;
        });
        html += '</div>';
      }
      list.innerHTML = html;
    }

    window.deleteGoal = function(id) {
      goals = goals.filter(g => g.id !== id);
      localStorage.setItem('seshlog_goals', JSON.stringify(goals));
      renderGoals();
    };

    // --- ACHIEVEMENTS ---
    const ACHIEVEMENTS = [
      { id: 'first-sesh', icon: 'ğŸ›¹', name: 'First Push', desc: 'Log your first session', check: () => sessions.length >= 1 },
      { id: 'five-sesh', icon: 'ğŸ–ï¸', name: 'High Five', desc: 'Log 5 sessions', check: () => sessions.length >= 5 },
      { id: 'ten-sesh', icon: 'ğŸ”Ÿ', name: 'Dedicated', desc: 'Log 10 sessions', check: () => sessions.length >= 10 },
      { id: 'twentyfive-sesh', icon: 'ğŸ†', name: 'Quarter Century', desc: 'Log 25 sessions', check: () => sessions.length >= 25 },
      { id: 'fifty-sesh', icon: 'ğŸ‘‘', name: 'Session King', desc: 'Log 50 sessions', check: () => sessions.length >= 50 },
      { id: 'hundred-sesh', icon: 'ğŸ’¯', name: 'Centurion', desc: 'Log 100 sessions', check: () => sessions.length >= 100 },
      { id: 'first-trick', icon: 'âœ¨', name: 'Trick Unlocked', desc: 'Land your first trick', check: () => sessions.some(s => s.tricks.length > 0) },
      { id: 'five-unique', icon: 'ğŸ¯', name: 'Variety Pack', desc: 'Land 5 different tricks', check: () => new Set(sessions.flatMap(s => s.tricks)).size >= 5 },
      { id: 'ten-unique', icon: 'ğŸŒŸ', name: 'Jack of All Trades', desc: 'Land 10 different tricks', check: () => new Set(sessions.flatMap(s => s.tricks)).size >= 10 },
      { id: 'twenty-unique', icon: 'ğŸ¦„', name: 'Trick Master', desc: 'Land 20 different tricks', check: () => new Set(sessions.flatMap(s => s.tricks)).size >= 20 },
      { id: 'one-hour', icon: 'â±ï¸', name: 'Hour of Power', desc: 'Log a 60+ minute session', check: () => sessions.some(s => (s.duration || 0) >= 60) },
      { id: 'two-hours', icon: 'ğŸ•', name: 'Marathon', desc: 'Log a 120+ minute session', check: () => sessions.some(s => (s.duration || 0) >= 120) },
      { id: 'ten-hours', icon: 'âŒ›', name: 'Time Invested', desc: 'Total 10 hours on board', check: () => sessions.reduce((a, s) => a + (s.duration || 0), 0) >= 600 },
      { id: 'streak-3', icon: 'ğŸ”¥', name: 'On Fire', desc: '3-day skate streak', check: () => calcMaxStreak() >= 3 },
      { id: 'streak-7', icon: 'ğŸ”¥', name: 'Week Warrior', desc: '7-day skate streak', check: () => calcMaxStreak() >= 7 },
      { id: 'streak-30', icon: 'ğŸŒ‹', name: 'Unstoppable', desc: '30-day skate streak', check: () => calcMaxStreak() >= 30 },
      { id: 'fire-mood', icon: 'ğŸ˜', name: 'Vibing', desc: 'Log 5 ğŸ”¥ mood sessions', check: () => sessions.filter(s => s.mood === 'ğŸ”¥').length >= 5 },
      { id: 'first-goal', icon: 'ğŸ¯', name: 'Goal Setter', desc: 'Complete your first goal', check: () => goals.some(g => g.completed) },
      { id: 'five-goals', icon: 'ğŸ…', name: 'Achiever', desc: 'Complete 5 goals', check: () => goals.filter(g => g.completed).length >= 5 },
      { id: 'photographer', icon: 'ğŸ“¸', name: 'Shutterbug', desc: 'Add photos to 3 sessions', check: () => sessions.filter(s => s.photo).length >= 3 },
    ];

    function calcMaxStreak() {
      const dates = [...new Set(sessions.map(s => s.date))].sort();
      if (!dates.length) return 0;
      let max = 1, cur = 1;
      for (let i = 1; i < dates.length; i++) {
        const prev = new Date(dates[i - 1]);
        const curr = new Date(dates[i]);
        const diff = (curr - prev) / 86400000;
        if (diff === 1) { cur++; max = Math.max(max, cur); }
        else if (diff > 1) cur = 1;
      }
      return max;
    }

    function checkBadges() {
      let newBadge = false;
      ACHIEVEMENTS.forEach(a => {
        if (!unlockedBadges[a.id] && a.check()) {
          unlockedBadges[a.id] = new Date().toISOString();
          newBadge = true;
        }
      });
      if (newBadge) localStorage.setItem('seshlog_badges', JSON.stringify(unlockedBadges));
      return newBadge;
    }

    function renderAchievements() {
      checkBadges();
      const grid = document.getElementById('achievements-grid');
      const unlocked = ACHIEVEMENTS.filter(a => unlockedBadges[a.id]);
      const locked = ACHIEVEMENTS.filter(a => !unlockedBadges[a.id]);
      grid.innerHTML = `<p style="color:var(--muted);font-size:0.85rem;margin-bottom:16px">ğŸ… ${unlocked.length} / ${ACHIEVEMENTS.length} unlocked</p><div class="badge-grid">` +
        [...unlocked, ...locked].map(a => {
          const isUnlocked = !!unlockedBadges[a.id];
          const date = isUnlocked ? new Date(unlockedBadges[a.id]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
          return `<div class="card badge-card${isUnlocked ? '' : ' locked'}">
            <div class="badge-icon">${a.icon}</div>
            <div class="badge-name">${a.name}</div>
            <div class="badge-desc">${a.desc}</div>
            ${isUnlocked ? `<div class="badge-date">Unlocked ${date}</div>` : ''}
          </div>`;
        }).join('') + '</div>';
    }

    // Check badges on session save
    const origSaveHandler = document.getElementById('save-btn').onclick;
    document.getElementById('save-btn').addEventListener('click', () => {
      setTimeout(() => { if (checkBadges()) { /* could show toast */ } renderGoals(); }, 100);
    });

    // Initial render
    setTimeout(renderGoals, 500);

    // --- EXPORT / IMPORT ---
    document.getElementById('export-btn').addEventListener('click', () => {
      const data = { version: 1, exportedAt: new Date().toISOString(), sessions };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'seshlog-backup-' + new Date().toISOString().slice(0,10) + '.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    function parseImportFile(callback) {
      const file = document.getElementById('import-file').files[0];
      const status = document.getElementById('import-status');
      if (!file) { alert('Pick a JSON file first!'); return; }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const raw = JSON.parse(e.target.result);
          const imported = Array.isArray(raw) ? raw : (raw.sessions || []);
          // Validate
          if (!Array.isArray(imported)) throw new Error('Invalid format');
          const valid = imported.filter(s => s.id && s.date);
          if (!valid.length) throw new Error('No valid sessions found');
          callback(valid, status);
        } catch (err) {
          status.style.display = 'block';
          status.style.color = 'var(--red)';
          status.textContent = 'âŒ ' + err.message;
        }
      };
      reader.readAsText(file);
    }

    document.getElementById('import-merge-btn').addEventListener('click', () => {
      parseImportFile((imported, status) => {
        const existingIds = new Set(sessions.map(s => s.id));
        const newOnes = imported.filter(s => !existingIds.has(s.id));
        sessions = [...sessions, ...newOnes].sort((a, b) => b.date.localeCompare(a.date));
        localStorage.setItem('seshlog_sessions', JSON.stringify(sessions));
        status.style.display = 'block';
        status.style.color = 'var(--green)';
        status.textContent = 'âœ… Merged! ' + newOnes.length + ' new session(s) added (' + (imported.length - newOnes.length) + ' duplicates skipped).';
      });
    });

    document.getElementById('import-replace-btn').addEventListener('click', () => {
      if (!confirm('This will replace ALL your current sessions. Are you sure?')) return;
      parseImportFile((imported, status) => {
        sessions = imported.sort((a, b) => b.date.localeCompare(a.date));
        localStorage.setItem('seshlog_sessions', JSON.stringify(sessions));
        status.style.display = 'block';
        status.style.color = 'var(--green)';
        status.textContent = 'âœ… Replaced! ' + imported.length + ' session(s) imported.';
      });
    });
  </script>
</body>
</html>
